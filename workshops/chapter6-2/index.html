
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Learn how to implement tool interfaces for specialized retrievers and build an effective routing layer" name="description"/>
<link href="https://567-labs.github.io/systematically-improving-rag/workshops/chapter6-2/" rel="canonical"/>
<link href="../chapter6-1/" rel="prev"/>
<link href="../chapter6-3/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Tool Interfaces and Implementation - Systematically Improving RAG Applications</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></link></head>
<body data-md-color-accent="black" data-md-color-primary="black" data-md-color-scheme="slate" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#tool-interfaces-and-implementation-building-the-components">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
<aside class="md-banner">
<div class="md-banner__inner md-grid md-typeset">
<button aria-label="Don't show this again" class="md-banner__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
<p>
    This material is supported by <a href="https://maven.com/applied-llms/rag-playbook?promoCode=EBOOK" target="_blank"><strong>Applied LLMs on Maven</strong></a>.  Readers get 20% off.
    Not ready? Check out the <a href="https://fivesixseven.ck.page/rag-crash-course" target="_blank"><strong>free email course</strong></a>.
  </p>
</div>
<script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
</aside>
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Systematically Improving RAG Applications" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Systematically Improving RAG Applications">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Systematically Improving RAG Applications
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Tool Interfaces and Implementation
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="black" data-md-color-media="" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  
    
  
  Workshops

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../office-hours/">
        
  
  
    
  
  Office Hours

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../talks/">
          
  
  
    
  
  Talks

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../misc/learning-goals/">
          
  
  
    
  
  Resources

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Systematically Improving RAG Applications" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Systematically Improving RAG Applications">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Systematically Improving RAG Applications
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Workshops
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Workshops
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter0/">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
<span class="md-ellipsis">
    Chapter 1: Starting the Flywheel
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
            Chapter 1: Starting the Flywheel
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter1/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
<span class="md-ellipsis">
    Chapter 2: From Evaluation to Enhancement
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
            Chapter 2: From Evaluation to Enhancement
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter2/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
<span class="md-ellipsis">
    Chapter 3: User Experience
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
            Chapter 3: User Experience
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter3-1/">
<span class="md-ellipsis">
    Design Principles
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter3-2/">
<span class="md-ellipsis">
    Feedback Collection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter3-3/">
<span class="md-ellipsis">
    Iterative Improvement
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="">
<span class="md-ellipsis">
    Chapter 4: Topic Modeling
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
            Chapter 4: Topic Modeling
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter4-1/">
<span class="md-ellipsis">
    Analysis
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter4-2/">
<span class="md-ellipsis">
    Prioritization
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="">
<span class="md-ellipsis">
    Chapter 5: Multimodal Capabilities
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
            Chapter 5: Multimodal Capabilities
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter5-1/">
<span class="md-ellipsis">
    Understanding
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter5-2/">
<span class="md-ellipsis">
    Implementation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="">
<span class="md-ellipsis">
    Chapter 6: Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
            Chapter 6: Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter6-1/">
<span class="md-ellipsis">
    Routing
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Tools
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Tools
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-tool-interfaces-for-retrieval">
<span class="md-ellipsis">
      Implementing Tool Interfaces for Retrieval
    </span>
</a>
<nav aria-label="Implementing Tool Interfaces for Retrieval" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-blueprint-search-tool">
<span class="md-ellipsis">
      Building a Blueprint Search Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-document-search-tool">
<span class="md-ellipsis">
      Building a Document Search Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-power-of-tool-documentation">
<span class="md-ellipsis">
      The Power of Tool Documentation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#aside-on-mcp">
<span class="md-ellipsis">
      Aside on MCP
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-routing-layer">
<span class="md-ellipsis">
      Building the Routing Layer
    </span>
</a>
<nav aria-label="Building the Routing Layer" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-a-simple-router">
<span class="md-ellipsis">
      Implementing a Simple Router
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-few-shot-examples-to-improve-routing">
<span class="md-ellipsis">
      Using Few-Shot Examples to Improve Routing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dynamic-few-shot-example-selection">
<span class="md-ellipsis">
      Dynamic Few-Shot Example Selection
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../chapter6-3/">
<span class="md-ellipsis">
    Improvement
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../office-hours/">
<span class="md-ellipsis">
    Office Hours
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Office Hours
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/faq/">
<span class="md-ellipsis">
    FAQ
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/AGENTS/">
<span class="md-ellipsis">
    Agents
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 1: Starting the Flywheel
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            Chapter 1: Starting the Flywheel
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week1-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-1-1/">
<span class="md-ellipsis">
    Cohort 3 - Session 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-1-2/">
<span class="md-ellipsis">
    Cohort 3 - Session 2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 2: From Evaluation to Enhancement
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            Chapter 2: From Evaluation to Enhancement
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week2-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-2-1/">
<span class="md-ellipsis">
    Cohort 3 - Session 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-2-2/">
<span class="md-ellipsis">
    Cohort 3 - Session 2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 3: User Experience
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            Chapter 3: User Experience
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week3-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-3-1/">
<span class="md-ellipsis">
    Cohort 3 - Session 1
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 4: Topic Modeling
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            Chapter 4: Topic Modeling
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week4-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-4-1/">
<span class="md-ellipsis">
    Cohort 3 - Session 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-4-2/">
<span class="md-ellipsis">
    Cohort 3 - Session 2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 5: Multimodal Capabilities
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            Chapter 5: Multimodal Capabilities
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week5-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 5
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-5-1/">
<span class="md-ellipsis">
    Cohort 3 - Session 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort3/week-5-2/">
<span class="md-ellipsis">
    Cohort 3 - Session 2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
<span class="md-ellipsis">
    Chapter 6: Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_8">
<span class="md-nav__icon md-icon"></span>
            Chapter 6: Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../office-hours/cohort2/week6-summary/">
<span class="md-ellipsis">
    Cohort 2 - Week 6
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../talks/">
<span class="md-ellipsis">
    Talks
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Talks
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
<span class="md-ellipsis">
    Search / Indexing / Chunking
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
            Search / Indexing / Chunking
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/chromadb-anton-chunking/">
<span class="md-ellipsis">
    Text Chunking Strategies (Anton, ChromaDB)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/john-lexical-search/">
<span class="md-ellipsis">
    Lexical Search in RAG Applications (John Berryman)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/query-routing-anton/">
<span class="md-ellipsis">
    Query Routing for RAG Systems (Anton, ChromaDB)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/semantic-search-exa-will-bryk/">
<span class="md-ellipsis">
    Semantic Search Over the Web with Exa (Will Bryk, Exa)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/rag-without-apis-browser-michael-struwig/">
<span class="md-ellipsis">
    RAG Without APIs: Browser-Based Retrieval (Michael, OpenBB)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
<span class="md-ellipsis">
    Finetuning
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
            Finetuning
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/glean-manav/">
<span class="md-ellipsis">
    Enterprise Search and Fine-tuning Embedding Models (Manav, Glean)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/fine-tuning-rerankers-embeddings-ayush-lancedb/">
<span class="md-ellipsis">
    Fine-tuning Re-rankers and Embedding Models (Ayush, LanceDB)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/embedding-performance-generative-evals-kelly-hong/">
<span class="md-ellipsis">
    Understanding Embedding Performance through Generative Evals (Kelly Hong)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
<span class="md-ellipsis">
    Monitoring
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
            Monitoring
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/online-evals-production-monitoring-ben-sidhant/">
<span class="md-ellipsis">
    Online Evals and Production Monitoring (Ben &amp; Sidhant)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/rag-antipatterns-skylar-payne/">
<span class="md-ellipsis">
    RAG Anti-patterns in the Wild (Skylar Payne)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/zapier-vitor-evals/">
<span class="md-ellipsis">
    Building Feedback Systems for AI Products (Vitor, Zapier)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
<span class="md-ellipsis">
    Coding Agents
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_5">
<span class="md-nav__icon md-icon"></span>
            Coding Agents
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/rag-is-dead-cline-nik/">
<span class="md-ellipsis">
    Autonomous Coding Agents (Nik Pash, Cline)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/colin-rag-agents/">
<span class="md-ellipsis">
    Agentic RAG (Colin Flaherty)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
<span class="md-ellipsis">
    Document Processing
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_6">
<span class="md-nav__icon md-icon"></span>
            Document Processing
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/reducto-docs-adit/">
<span class="md-ellipsis">
    Better RAG Through Better Data (Adit, Reducto)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../talks/superlinked-encoder-stacking/">
<span class="md-ellipsis">
    Encoder Stacking and Multi-Modal Retrieval (Daniel, Superlinked)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Resources
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Resources
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../misc/learning-goals/">
<span class="md-ellipsis">
    Learning Goals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../misc/what-i-want-you-to-takeaway/">
<span class="md-ellipsis">
    Key Takeaways
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../misc/introduction/">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../misc/landingpage/">
<span class="md-ellipsis">
    Landing Page
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-tool-interfaces-for-retrieval">
<span class="md-ellipsis">
      Implementing Tool Interfaces for Retrieval
    </span>
</a>
<nav aria-label="Implementing Tool Interfaces for Retrieval" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-blueprint-search-tool">
<span class="md-ellipsis">
      Building a Blueprint Search Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-document-search-tool">
<span class="md-ellipsis">
      Building a Document Search Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-power-of-tool-documentation">
<span class="md-ellipsis">
      The Power of Tool Documentation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#aside-on-mcp">
<span class="md-ellipsis">
      Aside on MCP
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-routing-layer">
<span class="md-ellipsis">
      Building the Routing Layer
    </span>
</a>
<nav aria-label="Building the Routing Layer" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-a-simple-router">
<span class="md-ellipsis">
      Implementing a Simple Router
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-few-shot-examples-to-improve-routing">
<span class="md-ellipsis">
      Using Few-Shot Examples to Improve Routing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dynamic-few-shot-example-selection">
<span class="md-ellipsis">
      Dynamic Few-Shot Example Selection
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="tool-interfaces-and-implementation-building-the-components">Tool Interfaces and Implementation: Building the Components</h1>
<div class="admonition abstract">
<p class="admonition-title">Chapter Overview</p>
</div>
<div class="highlight"><pre><span></span><code>This part explores how to implement the key components of a unified RAG system:

- Implementing tool interfaces for different content types
- Building an effective query router using few-shot examples
- Creating a feedback loop that improves routing over time
- Measuring router performance separately from retriever performance
</code></pre></div>
<h2 id="implementing-tool-interfaces-for-retrieval">Implementing Tool Interfaces for Retrieval</h2>
<p>Let's look at how to implement this pattern with a concrete example. Imagine we're building a construction information system that includes blueprints, text documents, and project schedules.</p>
<div class="admonition note">
<p class="admonition-title">Drawing from Previous Chapters</p>
<ul>
<li><strong><a href="../chapter1/">Chapter 1</a></strong>: Evaluation metrics help test router accuracy</li>
<li><strong><a href="../chapter3-1/">Chapter 3</a></strong>: Feedback reveals which tools users need</li>
<li><strong><a href="../chapter4-2/">Chapter 4</a></strong>: Query analysis identifies tool requirements</li>
<li><strong><a href="../chapter5-1/">Chapter 5</a></strong>: Specialized retrievers become the tools</li>
</ul>
</div>
<h3 id="building-a-blueprint-search-tool">Building a Blueprint Search Tool</h3>
<p>Based on our analysis in Chapter 5, we've determined that users often search for blueprints by description and date range. We'll define a tool interface that captures this functionality:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchBlueprint</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BlueprintResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Search for blueprints matching the description and date range.</span>

<span class="sd">        Args:</span>
<span class="sd">            description: Text to search for in blueprint descriptions</span>
<span class="sd">            start_date: Optional start date in YYYY-MM-DD format</span>
<span class="sd">            end_date: Optional end date in YYYY-MM-DD format</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of matching blueprint documents</span>
<span class="sd">        """</span>
        <span class="c1"># Implementation details would depend on your database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="o">...</span>
</code></pre></div>
<h3 id="building-a-document-search-tool">Building a Document Search Tool</h3>
<p>Similarly, we can define a tool for searching text documents:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchText</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">document_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"contract"</span><span class="p">,</span> <span class="s2">"proposal"</span><span class="p">,</span> <span class="s2">"bid"</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DocumentResult</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_type</span><span class="p">:</span>
            <span class="n">filter_params</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_type</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_database</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filter_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
<h3 id="the-power-of-tool-documentation">The Power of Tool Documentation</h3>
<p>Notice the detailed docstrings and examples in these tool definitions. These aren't just for human developers—they're critical for language models to understand how and when to use each tool. The examples in particular help models recognize the patterns of queries that should trigger each tool.</p>
<div class="admonition tip">
<p class="admonition-title">Tool Portfolio Design Principles</p>
<p><strong>Tools vs Retrievers:</strong>
- Tools are NOT one-to-one with retrievers
- Think of tools like command-line utilities: multiple ways to access the same data
- A single retriever might power multiple tools with different interfaces</p>
<p><strong>Example: Document Retriever, Multiple Tools</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># One retriever, multiple access patterns</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentRetriever</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Core retrieval engine for all documents"""</span>
    <span class="k">pass</span>

<span class="c1"># Tool 1: Search by keyword</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SearchDocuments</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># Tool 2: Find by metadata</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FindDocumentsByMetadata</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">date_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DateRange</span><span class="p">]</span>
    <span class="n">document_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="c1"># Tool 3: Get related documents</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GetRelatedDocuments</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
</code></pre></div></p>
<p>This separation allows users to access the same underlying data in ways that match their mental models.</p>
</div>
<h3 id="aside-on-mcp">Aside on MCP</h3>
<p>The Model Context Protocol (MCP) is an open standard developed by Anthropic that standardizes how applications provide context to large language models. Conceptually similar to the tool interface pattern we've discussed, MCP creates a universal protocol for connecting AI systems to various data sources and tools.</p>
<p>Think of MCP like a "USB-C port for AI applications" – just as USB-C provides a standardized way to connect devices to various peripherals, MCP provides a standardized way for AI models to interact with different data sources and tools.</p>
<p>Key benefits of MCP include:</p>
<ol>
<li><strong>Standardization</strong>: Developers can build against a single protocol instead of maintaining separate connectors for each data source</li>
<li><strong>Interoperability</strong>: AI systems can maintain context as they move between different tools and datasets</li>
<li><strong>Ecosystem</strong>: Pre-built connectors for popular systems like GitHub, Slack, and databases can be shared and reused</li>
<li><strong>Security</strong>: The protocol is designed with security considerations for connecting AI to sensitive data sources</li>
</ol>
<p>MCP represents an important step toward the unified architecture vision we've discussed in this chapter, offering a standardized way to implement the "tools as APIs" pattern across different AI systems and data sources.</p>
<div class="admonition warning">
<p class="admonition-title">MCP is Still Emerging</p>
</div>
<div class="highlight"><pre><span></span><code>While MCP represents a promising approach to standardizing AI tool interfaces, it's important to note that it's still very new. As of now, there aren't many production-ready MCP implementations available, and the ecosystem of useful MCPs is still in its early stages of development. Organizations adopting MCP should be prepared for an evolving standard and limited availability of pre-built connectors. As with any emerging technology, early adopters will need to invest in building custom implementations and should expect the standard to evolve over time.
</code></pre></div>
<h2 id="building-the-routing-layer">Building the Routing Layer</h2>
<p>Once we have defined our specialized retrieval tools, we need a system that can route queries to the appropriate tools. This routing layer is responsible for:</p>
<ol>
<li>Understanding the user's query</li>
<li>Determining which tool(s) to call</li>
<li>Extracting the necessary parameters from the query</li>
<li>Calling the appropriate tools with those parameters</li>
<li>Combining results when multiple tools are used</li>
</ol>
<p>Modern language models excel at this kind of task, especially when provided with clear tool definitions and examples.</p>
<div class="admonition warning">
<p class="admonition-title">Router vs. Individual Retrievers</p>
</div>
<p>It's critical to distinguish between the performance of your router (selecting the right tools) and the performance of each individual retriever (finding relevant information). A perfect router with mediocre retrievers will still yield mediocre results, while a mediocre router with perfect retrievers might miss capabilities entirely.</p>
<div class="admonition info">
<p class="admonition-title">Multi-Agent vs Single-Agent Architecture</p>
<p><strong>When to Use Multi-Agent Systems:</strong></p>
<p><strong>Coordination Challenges:</strong>
- Agents sharing state is complex
- Message passing adds latency
- Debugging becomes harder
- Error cascades are common</p>
<p><strong>Primary Benefits:</strong>
1. <strong>Token Efficiency</strong>: Each agent sees only relevant context
2. <strong>Specialization</strong>: Different models for different tasks
3. <strong>Read/Write Separation</strong>: Critical for safety</p>
<p><strong>Read-Only vs Write Operations:</strong>
- Keep read operations in single agent when possible
- Separate write operations into specialized agents
- Example: Reading code (safe) vs modifying code (requires careful agent)</p>
<p><strong>Real-World Example:</strong>
A coding assistant might use:
- Single agent for code reading, analysis, explanation
- Specialized agent for code generation with guardrails
- Separate agent for file system operations</p>
<p>This separation ensures safety while maintaining efficiency.</p>
</div>
<h3 id="implementing-a-simple-router">Implementing a Simple Router</h3>
<p>Here's a basic implementation of a query router using the Instructor library for structured outputs:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">instructor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">instructor</span><span class="o">.</span><span class="n">from_openai</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ClarifyQuestion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Use this when you need more information from the user to understand their request."""</span>
    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AnswerQuestion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Use this when you can answer directly without retrieving documents."""</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">follow_ups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchBlueprint</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Use this to search for building plans and blueprints."""</span>
    <span class="n">blueprint_description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchText</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Use this to search for text documents like contracts, proposals, and bids."""</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">document_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"contract"</span><span class="p">,</span> <span class="s2">"proposal"</span><span class="p">,</span> <span class="s2">"bid"</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">route_query</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Routes a user query to the appropriate tool(s) based on the query content.</span>

<span class="sd">    This function analyzes the user's query and determines which tool or tools </span>
<span class="sd">    would be most appropriate to handle it. Multiple tools can be returned if needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The user's natural language query</span>

<span class="sd">    Returns:</span>
<span class="sd">        An iterable of tool objects that should be used to process this query</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">"gpt-4o-mini"</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"role"</span><span class="p">:</span> <span class="s2">"system"</span><span class="p">,</span>
                <span class="s2">"content"</span><span class="p">:</span> <span class="s2">"""</span>
<span class="s2">                You are a query router for a construction information system.</span>

<span class="s2">                Your job is to analyze the user's query and decide which tool(s) should handle it.</span>
<span class="s2">                You can return multiple tools if the query requires different types of information.</span>

<span class="s2">                Available tools:</span>
<span class="s2">                - SearchBlueprint: For finding building plans and blueprints</span>
<span class="s2">                - SearchText: For finding text documents like contracts and proposals</span>
<span class="s2">                - AnswerQuestion: For directly answering conceptual questions without retrieval</span>
<span class="s2">                - ClarifyQuestion: For asking follow-up questions when the query is unclear</span>

<span class="s2">                Here are examples of how to route different types of queries:</span>

<span class="s2">                &lt;examples&gt;</span>
<span class="s2">                ...</span>
<span class="s2">                &lt;/examples&gt;</span>
<span class="s2">                """</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span>
                <span class="s2">"content"</span><span class="p">:</span> <span class="n">query</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]</span>
    <span class="p">)</span>

<span class="c1"># Example usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_user_query</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Process a user query by routing it to the appropriate tools and executing them."""</span>
    <span class="c1"># Step 1: Route the query to appropriate tools</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">route_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># Step 2: Execute each tool and collect results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">SearchBlueprint</span><span class="p">):</span>
            <span class="c1"># Execute blueprint search</span>
            <span class="n">blueprints</span> <span class="o">=</span> <span class="n">search_blueprints</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">blueprint_description</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">end_date</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"blueprints"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">:</span> <span class="n">blueprints</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">SearchText</span><span class="p">):</span>
            <span class="c1"># Execute text search</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">search_documents</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
                <span class="n">document_type</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">document_type</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"documents"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">:</span> <span class="n">documents</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">AnswerQuestion</span><span class="p">):</span>
            <span class="c1"># Direct answer without retrieval</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"answer"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">content</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">ClarifyQuestion</span><span class="p">):</span>
            <span class="c1"># Return clarification question to user</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">"action"</span><span class="p">:</span> <span class="s2">"clarify"</span><span class="p">,</span> <span class="s2">"question"</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">question</span><span class="p">}</span>

    <span class="c1"># Step 3: Generate a response using the collected results</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"action"</span><span class="p">:</span> <span class="s2">"respond"</span><span class="p">,</span> <span class="s2">"results"</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div>
<h3 id="using-few-shot-examples-to-improve-routing">Using Few-Shot Examples to Improve Routing</h3>
<p>The effectiveness of the router depends significantly on providing good examples of when to use each tool. These few-shot examples help the model understand the patterns that should trigger different tools.</p>
<div class="admonition info">
<p class="admonition-title">Evolution of RAG Architectures</p>
<p><strong>From Embeddings to Tools:</strong></p>
<p>The progression of RAG architectures follows a predictable pattern:</p>
<ol>
<li><strong>Generation 1: Pure Embeddings</strong></li>
<li>Single vector database</li>
<li>Semantic search only</li>
<li>
<p>Limited to similarity matching</p>
</li>
<li>
<p><strong>Generation 2: Hybrid Search</strong></p>
</li>
<li>Combine semantic + lexical</li>
<li>Add metadata filtering</li>
<li>
<p>Still retrieval-focused</p>
</li>
<li>
<p><strong>Generation 3: Tool-Based</strong></p>
</li>
<li>Multiple specialized tools</li>
<li>Goes beyond retrieval</li>
<li>Includes actions and computations</li>
</ol>
<p><strong>Why This Evolution Happens:</strong>
- Users don't just want to find information
- They want to analyze, compare, compute
- Tools enable richer interactions
- Better matches user mental models</p>
<p><strong>Example Evolution:</strong>
<div class="highlight"><pre><span></span><code>V1: "Find documents about project X"
V2: "Find recent documents about project X by John"
V3: "Compare project X budget vs actuals and identify variances"
</code></pre></div></p>
<p>The third query requires tools that can compute, not just retrieve.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Complete the Journey</p>
<p>This chapter brings together all the concepts from the book:
- The improvement flywheel from <a href="../chapter0/">Chapter 0</a>
- Evaluation frameworks from <a href="../chapter1/">Chapter 1</a>
- Fine-tuning from <a href="../chapter2/">Chapter 2</a>
- Feedback loops from <a href="../chapter3-1/">Chapter 3</a>
- Query understanding from <a href="../chapter4-2/">Chapter 4</a>
- Specialized capabilities from <a href="../chapter5-1/">Chapter 5</a></p>
<p>The unified architecture is where everything comes together into a cohesive product.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Effective Few-Shot Examples</p>
<p>When creating few-shot examples for query routing:</p>
</div>
<div class="highlight"><pre><span></span><code>1. **Cover edge cases**: Include examples of ambiguous queries that could be interpreted multiple ways
2. **Include multi-tool examples**: Show when multiple tools should be used together
3. **Demonstrate hard decisions**: Show when similar-sounding queries should route to different tools
4. **Use real user queries**: Whenever possible, use actual queries from your users
5. **Maintain diversity**: Ensure examples cover all tools and important parameter combinations
</code></pre></div>
<p>For instance, a system prompt for routing might include examples like:</p>
<div class="highlight"><pre><span></span><code>&lt;examples&gt;
- "Find blueprints for the city hall built in 2010."
{
    "blueprint_description": "city hall blueprints",
    "start_date": "2010-01-01",
    "end_date": "2010-12-31"
}
- "I need plans for residential buildings constructed after 2015."
{
    "blueprint_description": "residential building plans",
    "start_date": "2015-01-01",
    "end_date": null
}
- "Can you find me the plans for a the 123 main st building?"
{
    "blueprint_description": "123 main st building",
    "start_date": null,
    "end_date": null
}
- "Show me blueprints for schools built between 2018 and 2020."
{
    "blueprint_description": "school blueprints",
    "start_date": "2018-01-01",
    "end_date": "2020-12-31"
}
- "I need the contract for the Johnson project."
{
    "query": "Johnson project contract",
    "document_type": "contract"
}
- "What's the difference between a blueprint and a floor plan?"
{
    "content": "Blueprints are technical architectural drawings that include detailed specifications for construction, while floor plans focus primarily on the layout and dimensions of rooms and spaces within a building.",
    "follow_ups": ["How do I read a blueprint?", "Can you show me examples of floor plans?"]
}
- "Can you explain what a load-bearing wall is?"
{
    "content": "A load-bearing wall is a structural element that supports the weight of the building above it, helping to transfer the load to the foundation. Removing or modifying load-bearing walls requires careful engineering considerations.",
    "follow_ups": ["How can I identify a load-bearing wall?", "What happens if you remove a load-bearing wall?"]
}
- "I'm not sure what kind of building plans I need for my renovation."
{
    "question": "Could you tell me more about your renovation project? What type of building is it, what changes are you planning to make, and do you need plans for permits or for construction guidance?"
}
- "Find me school building plans from 2018-2020 and any related bid documents."
[
    {
        "blueprint_description": "school building plans",
        "start_date": "2018-01-01",
        "end_date": "2020-12-31"
    },
    {
        "query": "school building bids",
        "document_type": "bid"
    }
]
&lt;/examples&gt;
</code></pre></div>
<h3 id="dynamic-few-shot-example-selection">Dynamic Few-Shot Example Selection</h3>
<p>As your system collects more data about successful interactions, you can move beyond static examples to a dynamic approach that selects the most relevant few-shot examples for each query:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">example_database</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">num_examples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Select the most relevant examples for a given query from an example database.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The user's query</span>
<span class="sd">        example_database: Database of previous successful interactions</span>
<span class="sd">        num_examples: Number of examples to return</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of the most relevant examples for this query</span>
<span class="sd">    """</span>
    <span class="c1"># Embed the query</span>
    <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">get_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># Calculate similarity with all examples in database</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">example_database</span><span class="p">:</span>
        <span class="n">example_embedding</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">"embedding"</span><span class="p">]</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">example_embedding</span><span class="p">)</span>
        <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">similarity</span><span class="p">,</span> <span class="n">example</span><span class="p">))</span>

    <span class="c1"># Sort by similarity and return top examples</span>
    <span class="n">similarities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">example</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">[:</span><span class="n">num_examples</span><span class="p">]]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">route_query_with_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Route query using dynamically selected examples."""</span>
    <span class="c1"># Get relevant examples for this query</span>
    <span class="n">relevant_examples</span> <span class="o">=</span> <span class="n">get_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">example_database</span><span class="p">)</span>

    <span class="c1"># Format examples for inclusion in prompt</span>
    <span class="n">examples_text</span> <span class="o">=</span> <span class="n">format_examples</span><span class="p">(</span><span class="n">relevant_examples</span><span class="p">)</span>

    <span class="c1"># Create prompt with dynamic examples</span>
    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">    You are a query router for a construction information system.</span>
<span class="s2">    Your job is to analyze the user's query and decide which tool(s) should handle it.</span>

<span class="s2">    Available tools:</span>
<span class="s2">    - SearchBlueprint: For finding building plans and blueprints</span>
<span class="s2">    - SearchText: For finding text documents like contracts and proposals</span>
<span class="s2">    - AnswerQuestion: For directly answering conceptual questions without retrieval</span>
<span class="s2">    - ClarifyQuestion: For asking follow-up questions when the query is unclear</span>

<span class="s2">    Here are examples of how to route different types of queries:</span>

<span class="s2">    </span><span class="si">{</span><span class="n">examples_text</span><span class="si">}</span>
<span class="s2">    """</span>

    <span class="c1"># Perform routing with dynamic prompt</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">"gpt-4o-mini"</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"system"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
<p>This approach ensures that your routing layer continuously improves as you collect more examples of successful interactions, creating a learning system that adapts to your users' query patterns.</p>
<hr/>
<p>IF you want to get discounts and 6 day email source on the topic make sure to subscribe to</p>
<script async="" data-uid="010fd9b52b" src="https://fivesixseven.kit.com/010fd9b52b/index.js"></script>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="Last update">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="July 5, 2025 04:32:08 UTC">July 5, 2025</span>
</span>
</aside>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Routing" class="md-footer__link md-footer__link--prev" href="../chapter6-1/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Routing
              </div>
</div>
</a>
<a aria-label="Next: Improvement" class="md-footer__link md-footer__link--next" href="../chapter6-3/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Improvement
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://twitter.com/jxnlco" rel="noopener" target="_blank" title="twitter.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.footer", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>