
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Learn how to implement tool interfaces for specialized retrievers and build an effective routing layer">
      
      
      
        <link rel="canonical" href="https://567-labs.github.io/rag/workshops/chapter6-2/">
      
      
        <link rel="prev" href="../chapter6-1/">
      
      
        <link rel="next" href="../chapter6-3/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Tool Interfaces and Implementation - The RAG Flywheel</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tool-interfaces-and-implementation-building-the-components" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="The RAG Flywheel" class="md-header__button md-logo" aria-label="The RAG Flywheel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The RAG Flywheel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tool Interfaces and Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Workshops

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../office-hours/" class="md-tabs__link">
          
  
  
    
  
  Office Hours

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../talks/" class="md-tabs__link">
          
  
  
    
  
  Talks

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../misc/learning-goals/" class="md-tabs__link">
          
  
  
    
  
  Resources

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The RAG Flywheel" class="md-nav__button md-logo" aria-label="The RAG Flywheel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The RAG Flywheel
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Workshops
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Workshops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 1: Starting the Flywheel
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 2: From Evaluation to Enhancement
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter3-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 3: UX - Design Principles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter3-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 3: UX - Feedback Collection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter3-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 3: UX - Iterative Improvement
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter4-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 4: Topic Modeling - Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter4-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 4: Topic Modeling - Prioritization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter5-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 5: Multimodal - Understanding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter5-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 5: Multimodal - Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter6-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 6: Architecture - Routing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Chapter 6: Architecture - Tools
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Chapter 6: Architecture - Tools
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementing-tool-interfaces-for-retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Tool Interfaces for Retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Tool Interfaces for Retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-blueprint-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Blueprint Search Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-document-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Document Search Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-power-of-tool-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      The Power of Tool Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aside-on-mcp" class="md-nav__link">
    <span class="md-ellipsis">
      Aside on MCP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-routing-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Routing Layer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the Routing Layer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-a-simple-router" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing a Simple Router
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-few-shot-examples-to-improve-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Using Few-Shot Examples to Improve Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-few-shot-example-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Few-Shot Example Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter6-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chapter 6: Architecture - Improvement
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../office-hours/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Office Hours
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Office Hours
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Cohort 2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Cohort 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week1-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week2-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week3-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week4-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week5-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort2/week6-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Week 6
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Cohort 3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Cohort 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_3_1" id="__nav_3_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Week 1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_1">
            <span class="md-nav__icon md-icon"></span>
            Week 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-1-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-1-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_3_2" id="__nav_3_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Week 2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2">
            <span class="md-nav__icon md-icon"></span>
            Week 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-2-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-2-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3_3" id="__nav_3_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Week 3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_3">
            <span class="md-nav__icon md-icon"></span>
            Week 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-3-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Week 4
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            Week 4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-4-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../office-hours/cohort3/week-4-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session 2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../talks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Talks
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Talks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/rag-antipatterns-skylar-payne/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG Anti-patterns in the Wild
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/semantic-search-exa-will-bryk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Semantic Search Over the Web with Exa
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/embedding-performance-generative-evals-kelly-hong/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding Embedding Performance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/online-evals-production-monitoring-ben-sidhant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Online Evals and Production Monitoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/rag-without-apis-browser-michael-struwig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG Without APIs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Resources
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/learning-goals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learning Goals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/what-i-want-you-to-takeaway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key Takeaways
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/landingpage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Landing Page
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementing-tool-interfaces-for-retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Tool Interfaces for Retrieval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Tool Interfaces for Retrieval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-blueprint-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Blueprint Search Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-document-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Document Search Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-power-of-tool-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      The Power of Tool Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aside-on-mcp" class="md-nav__link">
    <span class="md-ellipsis">
      Aside on MCP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-routing-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Routing Layer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the Routing Layer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-a-simple-router" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing a Simple Router
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-few-shot-examples-to-improve-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Using Few-Shot Examples to Improve Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-few-shot-example-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Few-Shot Example Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tool-interfaces-and-implementation-building-the-components">Tool Interfaces and Implementation: Building the Components</h1>
<div class="admonition abstract">
<p class="admonition-title">Chapter Overview</p>
</div>
<div class="highlight"><pre><span></span><code>This part explores how to implement the key components of a unified RAG system:

- Implementing tool interfaces for different content types
- Building an effective query router using few-shot examples
- Creating a feedback loop that improves routing over time
- Measuring router performance separately from retriever performance
</code></pre></div>
<h2 id="implementing-tool-interfaces-for-retrieval">Implementing Tool Interfaces for Retrieval</h2>
<p>Let's look at how to implement this pattern with a concrete example. Imagine we're building a construction information system that includes blueprints, text documents, and project schedules.</p>
<h3 id="building-a-blueprint-search-tool">Building a Blueprint Search Tool</h3>
<p>Based on our analysis in Chapter 5, we've determined that users often search for blueprints by description and date range. We'll define a tool interface that captures this functionality:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchBlueprint</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BlueprintResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for blueprints matching the description and date range.</span>

<span class="sd">        Args:</span>
<span class="sd">            description: Text to search for in blueprint descriptions</span>
<span class="sd">            start_date: Optional start date in YYYY-MM-DD format</span>
<span class="sd">            end_date: Optional end date in YYYY-MM-DD format</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of matching blueprint documents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implementation details would depend on your database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="o">...</span>
</code></pre></div>
<h3 id="building-a-document-search-tool">Building a Document Search Tool</h3>
<p>Similarly, we can define a tool for searching text documents:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchText</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">document_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;contract&quot;</span><span class="p">,</span> <span class="s2">&quot;proposal&quot;</span><span class="p">,</span> <span class="s2">&quot;bid&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DocumentResult</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_type</span><span class="p">:</span>
            <span class="n">filter_params</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_type</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_database</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filter_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
<h3 id="the-power-of-tool-documentation">The Power of Tool Documentation</h3>
<p>Notice the detailed docstrings and examples in these tool definitions. These aren't just for human developers—they're critical for language models to understand how and when to use each tool. The examples in particular help models recognize the patterns of queries that should trigger each tool.</p>
<h3 id="aside-on-mcp">Aside on MCP</h3>
<p>The Model Context Protocol (MCP) is an open standard developed by Anthropic that standardizes how applications provide context to large language models. Conceptually similar to the tool interface pattern we've discussed, MCP creates a universal protocol for connecting AI systems to various data sources and tools.</p>
<p>Think of MCP like a "USB-C port for AI applications" – just as USB-C provides a standardized way to connect devices to various peripherals, MCP provides a standardized way for AI models to interact with different data sources and tools.</p>
<p>Key benefits of MCP include:</p>
<ol>
<li><strong>Standardization</strong>: Developers can build against a single protocol instead of maintaining separate connectors for each data source</li>
<li><strong>Interoperability</strong>: AI systems can maintain context as they move between different tools and datasets</li>
<li><strong>Ecosystem</strong>: Pre-built connectors for popular systems like GitHub, Slack, and databases can be shared and reused</li>
<li><strong>Security</strong>: The protocol is designed with security considerations for connecting AI to sensitive data sources</li>
</ol>
<p>MCP represents an important step toward the unified architecture vision we've discussed in this chapter, offering a standardized way to implement the "tools as APIs" pattern across different AI systems and data sources.</p>
<div class="admonition warning">
<p class="admonition-title">MCP is Still Emerging</p>
</div>
<div class="highlight"><pre><span></span><code>While MCP represents a promising approach to standardizing AI tool interfaces, it&#39;s important to note that it&#39;s still very new. As of now, there aren&#39;t many production-ready MCP implementations available, and the ecosystem of useful MCPs is still in its early stages of development. Organizations adopting MCP should be prepared for an evolving standard and limited availability of pre-built connectors. As with any emerging technology, early adopters will need to invest in building custom implementations and should expect the standard to evolve over time.
</code></pre></div>
<h2 id="building-the-routing-layer">Building the Routing Layer</h2>
<p>Once we have defined our specialized retrieval tools, we need a system that can route queries to the appropriate tools. This routing layer is responsible for:</p>
<ol>
<li>Understanding the user's query</li>
<li>Determining which tool(s) to call</li>
<li>Extracting the necessary parameters from the query</li>
<li>Calling the appropriate tools with those parameters</li>
<li>Combining results when multiple tools are used</li>
</ol>
<p>Modern language models excel at this kind of task, especially when provided with clear tool definitions and examples.</p>
<div class="admonition warning">
<p class="admonition-title">Router vs. Individual Retrievers</p>
</div>
<p>It's critical to distinguish between the performance of your router (selecting the right tools) and the performance of each individual retriever (finding relevant information). A perfect router with mediocre retrievers will still yield mediocre results, while a mediocre router with perfect retrievers might miss capabilities entirely.</p>
<h3 id="implementing-a-simple-router">Implementing a Simple Router</h3>
<p>Here's a basic implementation of a query router using the Instructor library for structured outputs:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">instructor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">instructor</span><span class="o">.</span><span class="n">from_openai</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ClarifyQuestion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this when you need more information from the user to understand their request.&quot;&quot;&quot;</span>
    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AnswerQuestion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this when you can answer directly without retrieving documents.&quot;&quot;&quot;</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">follow_ups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchBlueprint</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this to search for building plans and blueprints.&quot;&quot;&quot;</span>
    <span class="n">blueprint_description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SearchText</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this to search for text documents like contracts, proposals, and bids.&quot;&quot;&quot;</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">document_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;contract&quot;</span><span class="p">,</span> <span class="s2">&quot;proposal&quot;</span><span class="p">,</span> <span class="s2">&quot;bid&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">route_query</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routes a user query to the appropriate tool(s) based on the query content.</span>

<span class="sd">    This function analyzes the user&#39;s query and determines which tool or tools </span>
<span class="sd">    would be most appropriate to handle it. Multiple tools can be returned if needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The user&#39;s natural language query</span>

<span class="sd">    Returns:</span>
<span class="sd">        An iterable of tool objects that should be used to process this query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                You are a query router for a construction information system.</span>

<span class="s2">                Your job is to analyze the user&#39;s query and decide which tool(s) should handle it.</span>
<span class="s2">                You can return multiple tools if the query requires different types of information.</span>

<span class="s2">                Available tools:</span>
<span class="s2">                - SearchBlueprint: For finding building plans and blueprints</span>
<span class="s2">                - SearchText: For finding text documents like contracts and proposals</span>
<span class="s2">                - AnswerQuestion: For directly answering conceptual questions without retrieval</span>
<span class="s2">                - ClarifyQuestion: For asking follow-up questions when the query is unclear</span>

<span class="s2">                Here are examples of how to route different types of queries:</span>

<span class="s2">                &lt;examples&gt;</span>
<span class="s2">                ...</span>
<span class="s2">                &lt;/examples&gt;</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]</span>
    <span class="p">)</span>

<span class="c1"># Example usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_user_query</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a user query by routing it to the appropriate tools and executing them.&quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Route the query to appropriate tools</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">route_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># Step 2: Execute each tool and collect results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">SearchBlueprint</span><span class="p">):</span>
            <span class="c1"># Execute blueprint search</span>
            <span class="n">blueprints</span> <span class="o">=</span> <span class="n">search_blueprints</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">blueprint_description</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">end_date</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;blueprints&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">blueprints</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">SearchText</span><span class="p">):</span>
            <span class="c1"># Execute text search</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">search_documents</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
                <span class="n">document_type</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">document_type</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;documents&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">documents</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">AnswerQuestion</span><span class="p">):</span>
            <span class="c1"># Direct answer without retrieval</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">content</span><span class="p">})</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">ClarifyQuestion</span><span class="p">):</span>
            <span class="c1"># Return clarification question to user</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;clarify&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">question</span><span class="p">}</span>

    <span class="c1"># Step 3: Generate a response using the collected results</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div>
<h3 id="using-few-shot-examples-to-improve-routing">Using Few-Shot Examples to Improve Routing</h3>
<p>The effectiveness of the router depends significantly on providing good examples of when to use each tool. These few-shot examples help the model understand the patterns that should trigger different tools.</p>
<div class="admonition tip">
<p class="admonition-title">Effective Few-Shot Examples</p>
</div>
<p>When creating few-shot examples for query routing:</p>
<div class="highlight"><pre><span></span><code>1. **Cover edge cases**: Include examples of ambiguous queries that could be interpreted multiple ways
2. **Include multi-tool examples**: Show when multiple tools should be used together
3. **Demonstrate hard decisions**: Show when similar-sounding queries should route to different tools
4. **Use real user queries**: Whenever possible, use actual queries from your users
5. **Maintain diversity**: Ensure examples cover all tools and important parameter combinations
</code></pre></div>
<p>For instance, a system prompt for routing might include examples like:</p>
<div class="highlight"><pre><span></span><code>&lt;examples&gt;
- &quot;Find blueprints for the city hall built in 2010.&quot;
{
    &quot;blueprint_description&quot;: &quot;city hall blueprints&quot;,
    &quot;start_date&quot;: &quot;2010-01-01&quot;,
    &quot;end_date&quot;: &quot;2010-12-31&quot;
}
- &quot;I need plans for residential buildings constructed after 2015.&quot;
{
    &quot;blueprint_description&quot;: &quot;residential building plans&quot;,
    &quot;start_date&quot;: &quot;2015-01-01&quot;,
    &quot;end_date&quot;: null
}
- &quot;Can you find me the plans for a the 123 main st building?&quot;
{
    &quot;blueprint_description&quot;: &quot;123 main st building&quot;,
    &quot;start_date&quot;: null,
    &quot;end_date&quot;: null
}
- &quot;Show me blueprints for schools built between 2018 and 2020.&quot;
{
    &quot;blueprint_description&quot;: &quot;school blueprints&quot;,
    &quot;start_date&quot;: &quot;2018-01-01&quot;,
    &quot;end_date&quot;: &quot;2020-12-31&quot;
}
- &quot;I need the contract for the Johnson project.&quot;
{
    &quot;query&quot;: &quot;Johnson project contract&quot;,
    &quot;document_type&quot;: &quot;contract&quot;
}
- &quot;What&#39;s the difference between a blueprint and a floor plan?&quot;
{
    &quot;content&quot;: &quot;Blueprints are technical architectural drawings that include detailed specifications for construction, while floor plans focus primarily on the layout and dimensions of rooms and spaces within a building.&quot;,
    &quot;follow_ups&quot;: [&quot;How do I read a blueprint?&quot;, &quot;Can you show me examples of floor plans?&quot;]
}
- &quot;Can you explain what a load-bearing wall is?&quot;
{
    &quot;content&quot;: &quot;A load-bearing wall is a structural element that supports the weight of the building above it, helping to transfer the load to the foundation. Removing or modifying load-bearing walls requires careful engineering considerations.&quot;,
    &quot;follow_ups&quot;: [&quot;How can I identify a load-bearing wall?&quot;, &quot;What happens if you remove a load-bearing wall?&quot;]
}
- &quot;I&#39;m not sure what kind of building plans I need for my renovation.&quot;
{
    &quot;question&quot;: &quot;Could you tell me more about your renovation project? What type of building is it, what changes are you planning to make, and do you need plans for permits or for construction guidance?&quot;
}
- &quot;Find me school building plans from 2018-2020 and any related bid documents.&quot;
[
    {
        &quot;blueprint_description&quot;: &quot;school building plans&quot;,
        &quot;start_date&quot;: &quot;2018-01-01&quot;,
        &quot;end_date&quot;: &quot;2020-12-31&quot;
    },
    {
        &quot;query&quot;: &quot;school building bids&quot;,
        &quot;document_type&quot;: &quot;bid&quot;
    }
]
&lt;/examples&gt;
</code></pre></div>
<h3 id="dynamic-few-shot-example-selection">Dynamic Few-Shot Example Selection</h3>
<p>As your system collects more data about successful interactions, you can move beyond static examples to a dynamic approach that selects the most relevant few-shot examples for each query:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">example_database</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">num_examples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select the most relevant examples for a given query from an example database.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The user&#39;s query</span>
<span class="sd">        example_database: Database of previous successful interactions</span>
<span class="sd">        num_examples: Number of examples to return</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of the most relevant examples for this query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Embed the query</span>
    <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">get_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># Calculate similarity with all examples in database</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">example_database</span><span class="p">:</span>
        <span class="n">example_embedding</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">example_embedding</span><span class="p">)</span>
        <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">similarity</span><span class="p">,</span> <span class="n">example</span><span class="p">))</span>

    <span class="c1"># Sort by similarity and return top examples</span>
    <span class="n">similarities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">example</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">[:</span><span class="n">num_examples</span><span class="p">]]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">route_query_with_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Route query using dynamically selected examples.&quot;&quot;&quot;</span>
    <span class="c1"># Get relevant examples for this query</span>
    <span class="n">relevant_examples</span> <span class="o">=</span> <span class="n">get_dynamic_examples</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">example_database</span><span class="p">)</span>

    <span class="c1"># Format examples for inclusion in prompt</span>
    <span class="n">examples_text</span> <span class="o">=</span> <span class="n">format_examples</span><span class="p">(</span><span class="n">relevant_examples</span><span class="p">)</span>

    <span class="c1"># Create prompt with dynamic examples</span>
    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    You are a query router for a construction information system.</span>
<span class="s2">    Your job is to analyze the user&#39;s query and decide which tool(s) should handle it.</span>

<span class="s2">    Available tools:</span>
<span class="s2">    - SearchBlueprint: For finding building plans and blueprints</span>
<span class="s2">    - SearchText: For finding text documents like contracts and proposals</span>
<span class="s2">    - AnswerQuestion: For directly answering conceptual questions without retrieval</span>
<span class="s2">    - ClarifyQuestion: For asking follow-up questions when the query is unclear</span>

<span class="s2">    Here are examples of how to route different types of queries:</span>

<span class="s2">    </span><span class="si">{</span><span class="n">examples_text</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Perform routing with dynamic prompt</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchBlueprint</span> <span class="o">|</span> <span class="n">SearchText</span> <span class="o">|</span> <span class="n">AnswerQuestion</span> <span class="o">|</span> <span class="n">ClarifyQuestion</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
<p>This approach ensures that your routing layer continuously improves as you collect more examples of successful interactions, creating a learning system that adapts to your users' query patterns.</p>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../chapter6-1/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Chapter 6: Architecture - Routing">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Chapter 6: Architecture - Routing
              </div>
            </div>
          </a>
        
        
          
          <a href="../chapter6-3/" class="md-footer__link md-footer__link--next" aria-label="Next: Chapter 6: Architecture - Improvement">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Chapter 6: Architecture - Improvement
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/jxnlco" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.footer", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
    
  </body>
</html>